let username,password,robotUsername;const loginButton=document.getElementById("login-button"),spawnButton=document.getElementById("spawnButton"),vrButton=document.getElementById("vrButton"),confirmLoginButton=document.getElementById("confirm-login-button"),remoteVideo=document.getElementById("remoteVideo"),enteredpw=document.getElementById("private-password-input"),submitPwBtn=document.getElementById("submit-password-button"),snackbar=document.getElementById("snackbar"),modalLogin=document.getElementById("modal-login"),closeLoginSpan=document.getElementById("close-login-modal"),usernameInput=document.getElementById("username-input"),passwordInput=document.getElementById("password-input"),robotUsernameInput=document.getElementById("robot-username-input"),modalPassword=document.getElementById("modal-enter-password"),pwModalSpan=document.getElementById("close-password-modal"),loadingOverlay=document.getElementById("loadingOverlay"),trackingDataSpan=document.getElementById("tracking-data"),container=document.getElementById("vr-container");let remoteStream,peerConnection,configuration,connectionTimeout,tokenrate,signalingSocket,inputChannel,responseHandlers={},emitter,attemptCount=0,tempPW="";const maxReconnectAttempts=20;let reconnectAttempts=0;const reconnectDelay=2e3;let isGuest=!0,botDeviceType,jmuxer,isVideoChannelReceivingData=!1;const wsUrl="https://sp4wn-signaling-server.onrender.com";function getCookie(e){let t=("; "+document.cookie).split("; "+e+"=");if(2==t.length)return t.pop().split(";").shift()}function openLoginModal(){modalLogin.style.display="block"}function login(){console.log("Logging in..."),username=usernameInput.value.toLowerCase(),password=passwordInput.value,isGuest=!username||!password,connectToSignalingServer()}async function connectToSignalingServer(){return console.log("Connecting to signaling server..."),new Promise((e,t)=>{signalingSocket=new WebSocket(wsUrl),connectionTimeout=setTimeout(()=>{try{signalingSocket.close()}catch(e){console.log(e)}t(Error("Connection timed out"))},1e4),signalingSocket.onopen=()=>{clearTimeout(connectionTimeout),reconnectAttempts=0,isGuest?send({type:"wslogin",guest:!0}):send({type:"wslogin",username:username,password:password}),e()},signalingSocket.onmessage=async t=>{let n=JSON.parse(t.data);emitter.emit(n.type,n),responseHandlers[n.type]?(responseHandlers[n.type](n),delete responseHandlers[n.type]):await handleSignalingData(n,e)},signalingSocket.onclose=()=>{clearTimeout(connectionTimeout),console.log("Disconnected from signaling server"),handleReconnect()},signalingSocket.onerror=e=>{clearTimeout(connectionTimeout),console.error("WebSocket error:",e),t(e)}})}function send(e){signalingSocket.send(JSON.stringify(e))}function handleReconnect(){if(reconnectAttempts<20){reconnectAttempts++;let e=2e3*reconnectAttempts;console.log(`Reconnecting in ${e/1e3} seconds... (Attempt ${reconnectAttempts})`),setTimeout(connectToSignalingServer,e)}else console.log("Max reconnect attempts reached. Please refresh the page.")}async function handleSignalingData(e,t){switch(e.type){case"authenticated":handleLogin(e.success,e.configuration,e.errormessage,e.username),t();break;case"offer":if(peerConnection){await peerConnection.setRemoteDescription(new RTCSessionDescription(e.offer));let n=await peerConnection.createAnswer();await peerConnection.setLocalDescription(n),send({type:"answer",answer:n,username:username,host:robotUsername})}else console.log("no answer peer connection");break;case"answer":if(peerConnection)try{await peerConnection.setRemoteDescription(new RTCSessionDescription(e.answer))}catch(r){console.error("Error when setting remote description: ",r)}else console.log("no answer peer connection");break;case"candidate":if(e.candidate)try{let i=new RTCIceCandidate(e.candidate);await peerConnection.addIceCandidate(i),console.log("ICE candidate added successfully.")}catch(o){console.error("Error adding ICE candidate:",o)}else console.warn("No ICE candidate in the message.");break;case"watch":watchStream(e.name,e.pw);break;case"endStream":endStream()}}function handleLogin(e,t,n,r){e?e&&(console.log("Successfully logged in"),modalLogin.style.display="none",configuration=t,username=r,console.log(username),isGuest||(loginButton.style.display="none")):"User is already logged in"==n?setTimeout(()=>{send({type:"wslogin",username:username,password:password}),console.log("Retrying login in 10 seconds"),showSnackbar("Retrying login in 10 seconds")},1e4):(console.log("Invalid login",n),showSnackbar("Invalid login",n))}async function initSpawn(){if(tokenrate>0){let e=await checkTokenBalance(username);if(!e){showSnackbar(`Not enough tokens. Rate: ${tokenrate}`),spawnButton.disabled=!1;return}}if(tokenrate<0){let t=checkTokenBalance(robotUsername);if(!t){showSnackbar(`Host doesn't have enough tokens. Rate: ${(Number(tokenrate)/1e6).toFixed(2)} tokens/min`),spawnButton.disabled=!1;return}}peerConnection&&("closed"!==peerConnection.connectionState||"closed"!==peerConnection.signalingState)&&(console.log("An existing PeerConnection is open. Closing it first."),peerConnection.close(),peerConnection=null),await closeDataChannels(),"pi"==botDeviceType||"dropbear"==botDeviceType?await openCustomConnection():await openPeerConnection(),peerConnection.onicecandidate=function(e){console.log("Received ice candidate"),e.candidate&&send({type:"candidate",candidate:e.candidate,othername:robotUsername})},send({type:"watch",username:username,host:robotUsername,pw:tempPW}),await startStream()}async function openPeerConnection(){peerConnection=new RTCPeerConnection(configuration),remoteStream=new MediaStream,remoteVideo.srcObject=remoteStream,peerConnection.ontrack=e=>{remoteStream.addTrack(e.track),console.log("Received track:",e.track)}}async function openCustomConnection(){jmuxer?console.log("jmuxer already initialized"):initJMuxer(),peerConnection=new RTCPeerConnection(configuration)}function initJMuxer(){(jmuxer=new window.JMuxer({node:remoteVideo,mode:"video",flushingTime:0,clearBuffer:!0,debug:!1})).on("error",handleJMuxerError)}function handleJMuxerError(e){console.error("JMuxer error:",e),resetJMuxer()}function resetJMuxer(){console.log("Resetting JMuxer..."),jmuxer&&(jmuxer.destroy(),jmuxer=null,console.log("JMuxer instance cleared.")),mediaSource&&(mediaSource.endOfStream(),mediaSource=null,console.log("MediaSource cleared.")),mediaSource=new MediaSource,remoteVideo.src=URL.createObjectURL(mediaSource),mediaSource.addEventListener("sourceopen",onSourceOpen)}function onSourceOpen(){console.log("MediaSource opened"),mediaSource.duration=Number.POSITIVE_INFINITY,initJMuxer()}async function startStream(){console.log("starting stream");try{let e=await handleVROnConnection();if(e){if(console.log("VR loaded"),await waitForChannelsToOpen()){console.log("Data channels are open. Proceeding with ICE status check...");let t=await checkICEStatus("connected");if(t){console.log("ICE connected. Proceeding with video confirmation...");let n=!1;if(n="pi"==botDeviceType||"dropbear"==botDeviceType?await checkIfVideoChannelIsReceivingData():await isStreamLive()){console.log("Stream is receiving data. Attempting token redemption..."),removeVideoOverlayListeners();let r=await startAutoRedeem(tokenrate);r?(console.log("Successfully started stream"),vrButton.style.display="inline-block",spawnButton.textContent="End",spawnButton.onclick=endStream):console.error("Token redemption failed.")}else throw Error("Stream is not live.")}else throw Error("ICE connection failed.")}else throw Error("Failed to open data channels.")}else throw Error("VR failed to load.")}catch(i){showSnackbar("Failed to start stream"),console.error(`Error: ${i.message}`),hideLoadingOverlay(),endStream(),spawnButton.disabled=!1}spawnButton.disabled=!1}function checkTokenBalance(e){return new Promise((t,n)=>{checkUserTokenBalance({type:"checkTokenBalance",username:e,tokenrate:tokenrate}).then(e=>{e.success?t(!0):n(Error("Balance check failed"))}).catch(e=>{n(e)})})}function checkUserTokenBalance(e){return new Promise((t,n)=>{signalingSocket.send(JSON.stringify(e),e=>{e&&n(e)}),emitter.once("balanceChecked",e=>{try{t(e)}catch(r){n(r)}})})}function verifyPassword(e,t){return new Promise((n,r)=>{sendPW({type:"checkPassword",username:e,password:t}).then(e=>{e.success?n(!0):r(Error("Password verification failed"))}).catch(e=>{r(e)})})}function sendPW(e){return new Promise((t,n)=>{responseHandlers.authbotpw=e=>{try{t(e)}catch(r){n(r)}},signalingSocket.send(JSON.stringify(e),e=>{if(e){n(e);return}})})}async function start(){if(robotUsername=robotUsernameInput.value,document.cookie=`robotusername=${encodeURIComponent(robotUsername)}; max-age=31536000; path=/`,!robotUsername){showSnackbar("Please enter the robot's username");return}spawnButton.disabled=!0;try{let e=await fetch(`${wsUrl}/fetch-robot-details?username=${encodeURIComponent(robotUsername)}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)throw Error("Error fetching profile");let t=await e.json();if(!t.isLive){showSnackbar("Robot isn't available"),spawnButton.disabled=!1;return}tokenrate=Number(t.tokenrate),botDeviceType=t.deviceType,t.isPrivate?modalPassword.style.display="block":initSpawn()}catch(n){console.error("Error checking robot status:",n),spawnButton.disabled=!1}}async function closeDataChannels(){return new Promise(e=>{peerConnection&&(inputChannel&&"open"===inputChannel.readyState&&(inputChannel.close(),inputChannel=null,console.log("Closed input channel.")),console.log("Closed data channels")),e()})}async function checkICEStatus(e){return(console.log("Checking ICE status"),peerConnection)?new Promise((t,n)=>{let r=0,i=setInterval(()=>{try{console.log("ICE Connection State:",peerConnection.iceConnectionState),peerConnection.iceConnectionState===e||"completed"===peerConnection.iceConnectionState?(clearInterval(i),console.log("ICE connection established."),t(!0)):r>=5?(clearInterval(i),console.error("ICE connection not established within the expected time."),n(Error("ICE connection not established within the expected time."))):r++}catch(o){clearInterval(i),console.error("An error occurred:",o),n(o)}},2e3)}):(console.error("No peer connection available"),Promise.resolve(!1))}async function handleVROnConnection(){return new Promise((e,t)=>{try{initializeVideoOverlay(),setTimeout(()=>{e(!0)},200)}catch(n){console.error("Error in handleVROnConnection:",n),t(!1)}})}function waitForChannelsToOpen(){return new Promise(async e=>{try{let t=await setupDataChannelListenerWithTimeout();e(t)}catch(n){console.error("Error opening channels:",n),e(!1)}})}function setupDataChannelListenerWithTimeout(){return new Promise((e,t)=>{let n=0,r,i;function o(){++n===r&&(i&&clearTimeout(i),e(!0))}r="pi"==botDeviceType||"dropbear"==botDeviceType?2:1,peerConnection.ondatachannel=e=>{let n=e.channel,r=n.label;switch(console.log(`Data channel of type "${r}" received.`),r){case"video":handleVideoChannel(n,o);break;case"input":handleInputChannel(n,o);break;default:console.warn(`Unknown data channel type: ${r}`),t(Error(`Unsupported data channel type: ${r}`))}},i=setTimeout(()=>{t(Error("Timeout: Data channels did not open within 15000 ms"))},15e3)})}function handleVideoChannel(e,t){(videoChannel=e).onopen=()=>{t()},videoChannel.onmessage=async e=>{isVideoChannelReceivingData=!0;let t=new Uint8Array(e.data);try{jmuxer.feed({video:t})}catch(n){console.error(n)}},videoChannel.onclose=()=>{isVideoChannelReceivingData=!1},videoChannel.onerror=e=>{console.error("Video channel error:",e)}}function handleInputChannel(e,t){(inputChannel=e).onopen=()=>{t()},inputChannel.onmessage=e=>{console.log("Received input channel message:",e.data)},inputChannel.onclose=()=>{console.log("Input channel has been closed"),exitVR(),endStream()},inputChannel.onerror=e=>{console.error("Input channel error:",e)}}async function isStreamLive(){return new Promise((e,t)=>{if(remoteStream&&remoteStream.getTracks().some(e=>"live"===e.readyState))e(!0);else{let n=()=>{remoteStream&&remoteStream.getTracks().some(e=>"live"===e.readyState)&&(e(!0),clearInterval(r))},r=setInterval(()=>{n()},1e3);setTimeout(()=>{clearInterval(r),t(Error("Stream is not live."))},1e3)}})}async function checkIfVideoChannelIsReceivingData(){return new Promise((e,t)=>{if(isVideoChannelReceivingData)e(!0);else{let n=setInterval(()=>{isVideoChannelReceivingData&&(clearInterval(n),e(!0))},100);setTimeout(()=>{clearInterval(n),t(Error("Video channel is not receiving data within the timeout period."))},15e3)}})}async function startAutoRedeem(){return new Promise((e,t)=>{let n={hostname:robotUsername,username:username,tokens:tokenrate};isGuest&&(n={...n,guest:!0}),fetch(`${wsUrl}/redeem`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(n=>{n.success?(console.log("Auto-redemption initiated on the server."),e(!0)):t(Error(n.error||"Redemption failed"))}).catch(e=>{console.error("Error initiating auto-redemption:",e),t(e)})})}async function stopAutoRedeem(){try{let e={userUsername:username,hostUsername:robotUsername};isGuest&&(e.guest=!0);let t=await fetch(`${wsUrl}/stopAutoRedeem`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await t.json();if(n.success)return console.log(n.message),!0;return console.error("Failed to stop auto-redemption:",n.error),!1}catch(r){return console.error("Error stopping auto-redemption:",r),!1}}async function endStream(){console.log("Ending stream"),stopAutoRedeem(),spawnButton.textContent="Spawn",spawnButton.onclick=start,vrButton.style.display="none",remoteVideo.srcObject=null,await closeDataChannels(),peerConnection&&(peerConnection.close(),peerConnection=null)}function showSnackbar(e){try{snackbar.textContent=e,snackbar.className="snackbar show",setTimeout(function(){snackbar.className=snackbar.className.replace("show","")},5e3)}catch(t){console.error("Error showing snackbar:",t)}}function initializeVideoOverlay(){showLoadingOverlay()}function removeVideoOverlayListeners(){hideLoadingOverlay()}function showLoadingOverlay(){loadingOverlay.style.display="flex"}function hideLoadingOverlay(){loadingOverlay.style.display="none"}document.addEventListener("DOMContentLoaded",()=>{let e=getCookie("robotusername");e&&(robotUsernameInput.value=decodeURIComponent(e)),emitter=new EventEmitter3,login()}),pwModalSpan.onclick=function(){modalPassword.style.display="none"},closeLoginSpan.onclick=function(){modalLogin.style.display="none"},submitPwBtn.onclick=async function(){if(""===enteredpw.value){showSnackbar("Please enter a password"),console.log("Please enter a password");return}if(""===robotUsername){showSnackbar("Update robotUsername"),console.log("Update robotUsername");return}submitPwBtn.disabled=!0,submitPwBtn.classList.add("disabled");let e=enteredpw.value;tempPW=e;try{let t=await verifyPassword(robotUsername,e);t?(modalPassword.style.display="none",initSpawn(),attemptCount=0):(attemptCount++,showSnackbar("Failed to authenticate password"))}catch(n){attemptCount++,showSnackbar("Error verifying password"),console.log("Error verifying password:",n)}attemptCount>=3?setTimeout(()=>{submitPwBtn.disabled=!1,submitPwBtn.classList.remove("disabled")},5e3):(submitPwBtn.disabled=!1,submitPwBtn.classList.remove("disabled"))};let scene,camera,renderer,xrSession,referenceSpace,videoMesh;async function setupScene(){if(container.style.display="block",(renderer=new THREE.WebGLRenderer({antialias:!0})).setSize(window.innerWidth,window.innerHeight),renderer.setPixelRatio(window.devicePixelRatio),container.appendChild(renderer.domElement),scene=new THREE.Scene,(camera=new THREE.PerspectiveCamera(90,window.innerWidth/window.innerHeight,.1,1e3)).position.set(0,0,1),remoteVideo.srcObject){console.log("Video source found"),remoteVideo.style.display="none";let e=new THREE.VideoTexture(remoteVideo);e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.format=THREE.RGBAFormat;let t=new THREE.MeshBasicMaterial({map:e,side:THREE.FrontSide}),n=remoteVideo.videoWidth/remoteVideo.videoHeight,r=window.innerWidth/window.innerHeight,i,o;n>r?o=(i=2)/n:i=(o=2)*n;let a=new THREE.PlaneGeometry(i,o);(videoMesh=new THREE.Mesh(a,t)).position.set(0,0,-2),scene.add(videoMesh),camera.lookAt(videoMesh.position),camera.aspect=r,camera.updateProjectionMatrix(),remoteVideo.loop=!0,remoteVideo.play(),console.log("Video should now be playing on the plane")}else console.warn("No video stream is set for remoteVideo");let s=new THREE.AmbientLight(16777215,.5);scene.add(s)}function updateVideomeshPosition(e,t){let n=new THREE.Vector3(0,0,-2);n.applyQuaternion(e.quaternion),t.position.copy(e.position).add(n),t.quaternion.copy(e.quaternion)}function animate(){renderer.xr.isPresenting?renderer.setAnimationLoop(()=>{renderer.render(scene,camera)}):(requestAnimationFrame(animate),renderer.render(scene,camera))}async function enterVR(){if(await setupScene(),vrButton.textContent="Exit VR",vrButton.onclick=exitVR,navigator.xr)try{let e=renderer.getContext();await e.makeXRCompatible();let t=await navigator.xr.requestSession("immersive-vr");console.log("Session requested successfully",t),renderer.xr.enabled=!0,renderer.setPixelRatio(window.devicePixelRatio),t.updateRenderState({baseLayer:new XRWebGLLayer(t,renderer.getContext())});let n=await t.requestReferenceSpace("local");function r(e,i){let o=i.getViewerPose(n);if(o){let a=o.transform.position,s=o.transform.orientation;updateVideomeshPosition(camera,videoMesh);let $=[];i.session.inputSources.forEach(e=>{if(e.gripSpace){let t=i.getPose(e.gripSpace,n);t&&$.push({gripPosition:t.transform.position,gripOrientation:t.transform.orientation})}if(e.targetRaySpace){let r=i.getPose(e.targetRaySpace,n);r&&$.push({targetPosition:r.transform.position,targetOrientation:r.transform.orientation})}});let c={head:{position:a,orientation:s},controllers:$};try{inputChannel&&"open"===inputChannel.readyState?(inputChannel.send(JSON.stringify(c)),console.log("Data sent:",JSON.stringify(c)),showSnackbar("Tracking data sent.")):(console.log("Input channel not open or not available"),showSnackbar("Tracking data not sent: channel unavailable.")),trackingDataSpan?(trackingDataSpan.textContent=JSON.stringify(c,null,2),showSnackbar("Tracking data updated in UI.")):(console.warn('Element with id "tracking-data" not found'),showSnackbar("Could not update tracking data in UI."))}catch(u){console.error("Error in tracking:",u),showSnackbar("Error in tracking: "+u.message)}}else console.log("No viewer pose available for this frame"),showSnackbar("No tracking data available for this frame.");renderer.render(scene,camera),t.requestAnimationFrame(r)}renderer.xr.setReferenceSpaceType("local"),renderer.xr.setSession(t),animate(),t.requestAnimationFrame(r)}catch(i){console.error("Failed to enter VR session:",i),vrButton.textContent="Enter VR",vrButton.onclick=enterVR,showSnackbar("Failed to enter VR: "+i.message)}else console.warn("WebXR API is not supported in this browser."),showSnackbar("WebXR is not supported in this browser.")}function exitVR(){try{renderer.xr.getSession()&&renderer.xr.getSession().end().then(()=>{console.log("VR session ended")}).catch(e=>{console.error("Error ending VR session:",e)}),container.style.display="none",remoteVideo.style.display="block",vrButton.textContent="Enter VR",vrButton.onclick=enterVR}catch(e){console.error("Error in exitVR function:",e)}}confirmLoginButton.onclick=login,spawnButton.onclick=start,vrButton.onclick=enterVR,loginButton.onclick=openLoginModal,passwordInput.addEventListener("keydown",function(e){"Enter"===e.key&&login()}),function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).EventEmitter3=e()}(function(){return(function e(t,n,r){function i(a,s){if(!n[a]){if(!t[a]){var $="function"==typeof require&&require;if(!s&&$)return $(a,!0);if(o)return o(a,!0);var c=Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[a]={exports:{}};t[a][0].call(u.exports,function(e){return i(t[a][1][e]||e)},u,u.exports,e,t,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i})({1:[function(e,t,n){"use strict";var r=Object.prototype.hasOwnProperty,i="~";function o(){}function a(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,n,r,o){if("function"!=typeof n)throw TypeError("The listener must be a function");var s=new a(n,r||e,o),$=i?i+t:t;return e._events[$]?e._events[$].fn?e._events[$]=[e._events[$],s]:e._events[$].push(s):(e._events[$]=s,e._eventsCount++),e}function $(e,t){0==--e._eventsCount?e._events=new o:delete e._events[t]}function c(){this._events=new o,this._eventsCount=0}Object.create&&(o.prototype=Object.create(null),(new o).__proto__||(i=!1)),c.prototype.eventNames=function(){var e,t,n=[];if(0===this._eventsCount)return n;for(t in e=this._events)r.call(e,t)&&n.push(i?t.slice(1):t);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},c.prototype.listeners=function(e){var t=i?i+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var r=0,o=n.length,a=Array(o);r<o;r++)a[r]=n[r].fn;return a},c.prototype.listenerCount=function(e){var t=i?i+e:e,n=this._events[t];return n?n.fn?1:n.length:0},c.prototype.emit=function(e,t,n,r,o,a){var s=i?i+e:e;if(!this._events[s])return!1;var $,c=this._events[s],u=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),u){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,r),!0;case 5:return c.fn.call(c.context,t,n,r,o),!0;case 6:return c.fn.call(c.context,t,n,r,o,a),!0}for(f=1,$=Array(u-1);f<u;f++)$[f-1]=arguments[f];c.fn.apply(c.context,$)}else for(var l,d=c.length,f=0;f<d;f++)switch(c[f].once&&this.removeListener(e,c[f].fn,void 0,!0),u){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,t);break;case 3:c[f].fn.call(c[f].context,t,n);break;case 4:c[f].fn.call(c[f].context,t,n,r);break;default:if(!$)for(l=1,$=Array(u-1);l<u;l++)$[l-1]=arguments[l];c[f].fn.apply(c[f].context,$)}return!0},c.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},c.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},c.prototype.removeListener=function(e,t,n,r){var o=i?i+e:e;if(!this._events[o])return this;if(!t)return $(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||r&&!a.once||n&&a.context!==n||$(this,o);else{for(var s=0,c=[],u=a.length;s<u;s++)(a[s].fn!==t||r&&!a[s].once||n&&a[s].context!==n)&&c.push(a[s]);c.length?this._events[o]=1===c.length?c[0]:c:$(this,o)}return this},c.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&$(this,t)):(this._events=new o,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=i,c.EventEmitter=c,void 0!==t&&(t.exports=c)},{}]},{},[1])(1)}),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("stream")):"function"==typeof define&&define.amd?define(["stream"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).JMuxer=t(e.stream)}(this,function(e){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&$(e,t)}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function e(t){return t.__proto__||Object.getPrototypeOf(t)})(e)}function $(e,t){return($=Object.setPrototypeOf||function e(t,n){return t.__proto__=n,t})(e,t)}function c(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function u(e){var t=function e(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function n(){var r,i=s(e);if(t){var o=s(this).constructor;r=Reflect.construct(i,arguments,o)}else r=i.apply(this,arguments);return function e(t,n){if(n&&("object"==typeof n||"function"==typeof n))return n;if(void 0!==n)throw TypeError("Derived constructors may only return object or undefined");return c(t)}(this,r)}}function l(e,t){if(e){if("string"==typeof e)return d(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return d(e,t)}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function f(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=l(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function h(e){if(x){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];x.apply(void 0,[e].concat(n))}}function p(e){if(y){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];y.apply(void 0,[e].concat(n))}}var x,y,m=function(){function e(t){n(this,e),this.payload=t,this.nri=(96&this.payload[0])>>5,this.ntype=31&this.payload[0],this.isvcl=1==this.ntype||5==this.ntype,this.stype="",this.isfmb=!1}return i(e,[{key:"toString",value:function t(){return"".concat(e.type(this),": NRI: ").concat(this.getNri())}},{key:"getNri",value:function e(){return this.nri}},{key:"type",value:function e(){return this.ntype}},{key:"isKeyframe",value:function t(){return this.ntype===e.IDR}},{key:"getPayload",value:function e(){return this.payload}},{key:"getPayloadSize",value:function e(){return this.payload.byteLength}},{key:"getSize",value:function e(){return 4+this.getPayloadSize()}},{key:"getData",value:function e(){var t=new Uint8Array(this.getSize());return new DataView(t.buffer).setUint32(0,this.getSize()-4),t.set(this.getPayload(),4),t}}],[{key:"NDR",get:function e(){return 1}},{key:"IDR",get:function e(){return 5}},{key:"SEI",get:function e(){return 6}},{key:"SPS",get:function e(){return 7}},{key:"PPS",get:function e(){return 8}},{key:"AUD",get:function e(){return 9}},{key:"TYPES",get:function t(){var n;return o(n={},e.IDR,"IDR"),o(n,e.SEI,"SEI"),o(n,e.SPS,"SPS"),o(n,e.PPS,"PPS"),o(n,e.NDR,"NDR"),o(n,e.AUD,"AUD"),n}},{key:"type",value:function t(n){return n.ntype in e.TYPES?e.TYPES[n.ntype]:"UNKNOWN"}}]),e}();function v(e,t){var n=new Uint8Array((0|e.byteLength)+(0|t.byteLength));return n.set(e,0),n.set(t,0|e.byteLength),n}function g(e){var t,n,r,i="";return n=parseInt((t=Math.floor(e))/3600,10)%24,r=parseInt(t/60,10)%60,t=t<0?0:t%60,n>0&&(i+=(n<10?"0"+n:n)+":"),i+=(r<10?"0"+r:r)+":"+(t<10?"0"+t:t)}var k=function(){function e(t){n(this,e),this.data=t,this.index=0,this.bitLength=8*t.byteLength}return i(e,[{key:"setData",value:function e(t){this.data=t,this.index=0,this.bitLength=8*t.byteLength}},{key:"bitsAvailable",get:function e(){return this.bitLength-this.index}},{key:"skipBits",value:function e(t){if(this.bitsAvailable<t)return!1;this.index+=t}},{key:"readBits",value:function e(t){var n=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return this.getBits(t,this.index,n)}},{key:"getBits",value:function e(t,n){var r=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(this.bitsAvailable<t)return 0;var i=n%8,o=this.data[n/8|0]&255>>>i,a=8-i;if(a>=t)return r&&(this.index+=t),o>>a-t;r&&(this.index+=a);var s=t-a;return o<<s|this.getBits(s,n+a,r)}},{key:"skipLZ",value:function e(){var t;for(t=0;t<this.bitLength-this.index;++t)if(0!==this.getBits(1,this.index+t,!1)){this.index+=t;break}return t}},{key:"skipUEG",value:function e(){this.skipBits(1+this.skipLZ())}},{key:"skipEG",value:function e(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function e(){var t=this.skipLZ();return this.readBits(t+1)-1}},{key:"readEG",value:function e(){var t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}},{key:"readBoolean",value:function e(){return 1===this.readBits(1)}},{key:"readUByte",value:function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.readBits(8*t)}},{key:"readUShort",value:function e(){return this.readBits(16)}},{key:"readUInt",value:function e(){return this.readBits(32)}}]),e}(),b=function(){function e(t){n(this,e),this.remuxer=t,this.track=t.mp4track}return i(e,[{key:"parseSPS",value:function t(n){var r=e.readSPS(new Uint8Array(n));this.track.fps=r.fps,this.track.width=r.width,this.track.height=r.height,this.track.sps=[new Uint8Array(n)],this.track.codec="avc1.";for(var i=new DataView(n.buffer,n.byteOffset+1,4),o=0;o<3;++o){var a=i.getUint8(o).toString(16);a.length<2&&(a="0"+a),this.track.codec+=a}}},{key:"parsePPS",value:function e(t){this.track.pps=[new Uint8Array(t)]}},{key:"parseNAL",value:function e(t){if(!t)return!1;var n=!1;switch(t.type()){case m.IDR:case m.NDR:n=!0;break;case m.PPS:!this.track.pps&&(this.parsePPS(t.getPayload()),!this.remuxer.readyToDecode&&this.track.pps&&this.track.sps&&(this.remuxer.readyToDecode=!0)),n=!0;break;case m.SPS:!this.track.sps&&(this.parseSPS(t.getPayload()),!this.remuxer.readyToDecode&&this.track.pps&&this.track.sps&&(this.remuxer.readyToDecode=!0)),n=!0;break;case m.AUD:h("AUD - ignoing");break;case m.SEI:h("SEI - ignoing")}return n}}],[{key:"extractNALu",value:function e(t){for(var n,r,i=0,o=t.byteLength,a=0,s=[],$=0;i<o;)switch(n=t[i++],a){case 0:0===n&&(a=1);break;case 1:a=0===n?2:0;break;case 2:case 3:0===n?a=3:(1===n&&i<o&&($!=i-a-1&&s.push(t.subarray($,i-a-1)),$=i),a=0)}return $<o&&(r=t.subarray($,o)),[s,r]}},{key:"skipScalingList",value:function e(t,n){for(var r,i=8,o=8,a=0;a<n;a++)0!==o&&(o=(i+(r=t.readEG())+256)%256),i=0===o?i:o}},{key:"readSPS",value:function t(n){var r,i,o,a,s,$,c=new k(n),u=0,l=0,d=0,f=0,h=1,p=0;c.readUByte();for(var x=[],y=1,m=n.byteLength,v=y;v<m;v++)v+2<m&&3===c.readBits(24,!1)?(x.push(c.readBits(8)),x.push(c.readBits(8)),v+=2,c.readBits(8)):x.push(c.readBits(8));if(c.setData(new Uint8Array(x)),r=c.readUByte(),c.readBits(5),c.skipBits(3),c.readUByte(),c.skipUEG(),100===r||110===r||122===r||244===r||44===r||83===r||86===r||118===r||128===r){var g=c.readUEG();if(3===g&&c.skipBits(1),c.skipUEG(),c.skipUEG(),c.skipBits(1),c.readBoolean()){$=3!==g?8:12;for(var b=0;b<$;++b)c.readBoolean()&&(b<6?e.skipScalingList(c,16):e.skipScalingList(c,64))}}c.skipUEG();var _=c.readUEG();if(0===_)c.readUEG();else if(1===_){c.skipBits(1),c.skipEG(),c.skipEG(),i=c.readUEG();for(var w=0;w<i;++w)c.skipEG()}if(c.skipUEG(),c.skipBits(1),o=c.readUEG(),a=c.readUEG(),0===(s=c.readBits(1))&&c.skipBits(1),c.skipBits(1),c.readBoolean()&&(u=c.readUEG(),l=c.readUEG(),d=c.readUEG(),f=c.readUEG()),c.readBoolean()){if(c.readBoolean()){var S,C=c.readUByte();switch(C){case 1:S=[1,1];break;case 2:S=[12,11];break;case 3:S=[10,11];break;case 4:S=[16,11];break;case 5:S=[40,33];break;case 6:S=[24,11];break;case 7:S=[20,11];break;case 8:S=[32,11];break;case 9:S=[80,33];break;case 10:S=[18,11];break;case 11:S=[15,11];break;case 12:S=[64,33];break;case 13:S=[160,99];break;case 14:S=[4,3];break;case 15:S=[3,2];break;case 16:S=[2,1];break;case 255:S=[c.readUByte()<<8|c.readUByte(),c.readUByte()<<8|c.readUByte()]}S&&S[0]>0&&S[1]>0&&(h=S[0]/S[1])}if(c.readBoolean()&&c.skipBits(1),c.readBoolean()&&(c.skipBits(4),c.readBoolean()&&c.skipBits(24)),c.readBoolean()&&(c.skipUEG(),c.skipUEG()),c.readBoolean()){var F,B=c.readUInt(),E=c.readUInt();c.readBoolean()&&(p=E/(2*B))}}return{fps:p>0?p:void 0,width:Math.ceil(((o+1)*16-2*u-2*l)*h),height:(2-s)*(a+1)*16-(s?2:4)*(d+f)}}},{key:"parseHeader",value:function e(t){var n=new k(t.getPayload());n.readUByte(),t.isfmb=0===n.readUEG(),t.stype=n.readUEG()}}]),e}(),_=function(){function e(t){n(this,e),this.remuxer=t,this.track=t.mp4track}return i(e,[{key:"setAACConfig",value:function t(){var n,r,i,o=new Uint8Array(2),a=e.aacHeader;a&&(n=((192&a[2])>>>6)+1,r=(60&a[2])>>>2,i=(1&a[2])<<2,i|=(192&a[3])>>>6,o[0]=n<<3,o[0]|=(14&r)>>1,o[1]|=(1&r)<<7,o[1]|=i<<3,this.track.codec="mp4a.40."+n,this.track.channelCount=i,this.track.config=o,this.remuxer.readyToDecode=!0)}}],[{key:"samplingRateMap",get:function e(){return[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]}},{key:"getHeaderLength",value:function e(t){return 1&t[1]?7:9}},{key:"getFrameLength",value:function e(t){return(3&t[3])<<11|t[4]<<3|(224&t[5])>>>5}},{key:"isAACPattern",value:function e(t){return 255===t[0]&&(240&t[1])==240&&(6&t[1])==0}},{key:"extractAAC",value:function t(n){var r,i,o=0,a=n.byteLength,s=[];if(!e.isAACPattern(n))return p("Invalid ADTS audio format"),s;for(r=e.getHeaderLength(n),e.aacHeader||(e.aacHeader=n.subarray(0,r));o<a;)i=e.getFrameLength(n),s.push(n.subarray(r,i)),n=n.slice(i),o+=i;return s}}]),e}();o(_,"aacHeader",void 0);var w=function(){function e(t){n(this,e),this.listener={},this.type=""|t}return i(e,[{key:"on",value:function e(t,n){return this.listener[t]||(this.listener[t]=[]),this.listener[t].push(n),!0}},{key:"off",value:function e(t,n){if(this.listener[t]){var r=this.listener[t].indexOf(n);return r>-1&&this.listener[t].splice(r,1),!0}return!1}},{key:"offAll",value:function e(){this.listener={}}},{key:"dispatch",value:function e(t,n){return!!this.listener[t]&&(this.listener[t].map(function(e){e.apply(null,[n])}),!0)}}]),e}(),S=function(){function e(){n(this,e)}return i(e,null,[{key:"init",value:function t(){for(n in e.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},e.types)e.types.hasOwnProperty(n)&&(e.types[n]=[n.charCodeAt(0),n.charCodeAt(1),n.charCodeAt(2),n.charCodeAt(3)]);var n,r=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);e.HDLR_TYPES={video:r,audio:i};var o=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),a=new Uint8Array([0,0,0,0,0,0,0,0]);e.STTS=e.STSC=e.STCO=a,e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var s=new Uint8Array([105,115,111,109]),$=new Uint8Array([97,118,99,49]),c=new Uint8Array([0,0,0,1]);e.FTYP=e.box(e.types.ftyp,s,c,s,$),e.DINF=e.box(e.types.dinf,e.box(e.types.dref,o))}},{key:"box",value:function e(t){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];for(var o,a=8,s=r.length,$=s;s--;)a+=r[s].byteLength;for((o=new Uint8Array(a))[0]=a>>24&255,o[1]=a>>16&255,o[2]=a>>8&255,o[3]=255&a,o.set(t,4),s=0,a=8;s<$;++s)o.set(r[s],a),a+=r[s].byteLength;return o}},{key:"hdlr",value:function t(n){return e.box(e.types.hdlr,e.HDLR_TYPES[n])}},{key:"mdat",value:function t(n){return e.box(e.types.mdat,n)}},{key:"mdhd",value:function t(n,r){return e.box(e.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}},{key:"mdia",value:function t(n){return e.box(e.types.mdia,e.mdhd(n.timescale,n.duration),e.hdlr(n.type),e.minf(n))}},{key:"mfhd",value:function t(n){return e.box(e.types.mfhd,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,255&n]))}},{key:"minf",value:function t(n){return"audio"===n.type?e.box(e.types.minf,e.box(e.types.smhd,e.SMHD),e.DINF,e.stbl(n)):e.box(e.types.minf,e.box(e.types.vmhd,e.VMHD),e.DINF,e.stbl(n))}},{key:"moof",value:function t(n,r,i){return e.box(e.types.moof,e.mfhd(n),e.traf(i,r))}},{key:"moov",value:function t(n,r,i){for(var o=n.length,a=[];o--;)a[o]=e.trak(n[o]);return e.box.apply(null,[e.types.moov,e.mvhd(i,r)].concat(a).concat(e.mvex(n)))}},{key:"mvex",value:function t(n){for(var r=n.length,i=[];r--;)i[r]=e.trex(n[r]);return e.box.apply(null,[e.types.mvex].concat(i))}},{key:"mvhd",value:function t(n,r){var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.box(e.types.mvhd,i)}},{key:"sdtp",value:function t(n){var r,i,o=n.samples||[],a=new Uint8Array(4+o.length);for(i=0;i<o.length;i++)r=o[i].flags,a[i+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return e.box(e.types.sdtp,a)}},{key:"stbl",value:function t(n){return e.box(e.types.stbl,e.stsd(n),e.box(e.types.stts,e.STTS),e.box(e.types.stsc,e.STSC),e.box(e.types.stsz,e.STSZ),e.box(e.types.stco,e.STCO))}},{key:"avc1",value:function t(n){var r,i,o,a=[],s=[];for(r=0;r<n.sps.length;r++)o=(i=n.sps[r]).byteLength,a.push(o>>>8&255),a.push(255&o),a=a.concat(Array.prototype.slice.call(i));for(r=0;r<n.pps.length;r++)o=(i=n.pps[r]).byteLength,s.push(o>>>8&255),s.push(255&o),s=s.concat(Array.prototype.slice.call(i));var $=e.box(e.types.avcC,new Uint8Array([1,a[3],a[4],a[5],255,224|n.sps.length].concat(a).concat([n.pps.length]).concat(s))),c=n.width,u=n.height;return e.box(e.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,c>>8&255,255&c,u>>8&255,255&u,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,98,105,110,101,108,112,114,111,46,114,117,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),$,e.box(e.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))}},{key:"esds",value:function e(t){var n=t.config.byteLength,r=new Uint8Array(26+n+3);return r.set([0,0,0,0,3,23+n,0,1,0,4,15+n,64,21,0,0,0,0,0,0,0,0,0,0,0,5,n]),r.set(t.config,26),r.set([6,1,2],26+n),r}},{key:"mp4a",value:function t(n){var r=n.audiosamplerate;return e.box(e.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,n.channelCount,0,16,0,0,0,0,r>>8&255,255&r,0,0]),e.box(e.types.esds,e.esds(n)))}},{key:"stsd",value:function t(n){return"audio"===n.type?e.box(e.types.stsd,e.STSD,e.mp4a(n)):e.box(e.types.stsd,e.STSD,e.avc1(n))}},{key:"tkhd",value:function t(n){var r=n.id,i=n.duration,o=n.width,a=n.height,s=n.volume;return e.box(e.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,r>>24&255,r>>16&255,r>>8&255,255&r,0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,0,0,0,0,0,0,0,0,0,0,0,0,s>>0&255,s%1*10>>0&255,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,o>>8&255,255&o,0,0,a>>8&255,255&a,0,0]))}},{key:"traf",value:function t(n,r){var i=e.sdtp(n),o=n.id;return e.box(e.types.traf,e.box(e.types.tfhd,new Uint8Array([0,0,0,0,o>>24,o>>16&255,o>>8&255,255&o])),e.box(e.types.tfdt,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),e.trun(n,i.length+16+16+8+16+8+8),i)}},{key:"trak",value:function t(n){return n.duration=n.duration||4294967295,e.box(e.types.trak,e.tkhd(n),e.mdia(n))}},{key:"trex",value:function t(n){var r=n.id;return e.box(e.types.trex,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trun",value:function t(n,r){var i,o,a,s,$,c,u=n.samples||[],l=u.length,d=12+16*l,f=new Uint8Array(d);for(r+=8+d,f.set([0,0,15,1,l>>>24&255,l>>>16&255,l>>>8&255,255&l,r>>>24&255,r>>>16&255,r>>>8&255,255&r],0),i=0;i<l;i++)a=(o=u[i]).duration,s=o.size,$=o.flags,c=o.cts,f.set([a>>>24&255,a>>>16&255,a>>>8&255,255&a,s>>>24&255,s>>>16&255,s>>>8&255,255&s,$.isLeading<<2|$.dependsOn,$.isDependedOn<<6|$.hasRedundancy<<4|$.paddingValue<<1|$.isNonSync,61440&$.degradPrio,15&$.degradPrio,c>>>24&255,c>>>16&255,c>>>8&255,255&c],12+16*i);return e.box(e.types.trun,f)}},{key:"initSegment",value:function t(n,r,i){e.types||e.init();var o,a=e.moov(n,r,i);return(o=new Uint8Array(e.FTYP.byteLength+a.byteLength)).set(e.FTYP),o.set(a,e.FTYP.byteLength),o}}]),e}(),C=1,F=function(){function e(){n(this,e)}return i(e,[{key:"flush",value:function e(){this.mp4track.len=0,this.mp4track.samples=[]}},{key:"isReady",value:function e(){return!!this.readyToDecode&&!!this.samples.length||null}}],[{key:"getTrackID",value:function e(){return C++}}]),e}(),B=function(e){a(r,e);var t=u(r);function r(e){var i;return n(this,r),(i=t.call(this)).readyToDecode=!1,i.nextDts=0,i.dts=0,i.mp4track={id:F.getTrackID(),type:"audio",channelCount:0,len:0,fragmented:!0,timescale:e,duration:e,samples:[],config:"",codec:""},i.samples=[],i.aac=new _(c(i)),i}return i(r,[{key:"resetTrack",value:function e(){this.readyToDecode=!1,this.mp4track.codec="",this.mp4track.channelCount="",this.mp4track.config="",this.mp4track.timescale=this.timescale,this.nextDts=0,this.dts=0}},{key:"remux",value:function e(t){if(t.length>0)for(var n=0;n<t.length;n++){var r=t[n],i=r.units,o=i.byteLength;this.samples.push({units:i,size:o,duration:r.duration}),this.mp4track.len+=o,this.readyToDecode||this.aac.setAACConfig()}}},{key:"getPayload",value:function e(){if(!this.isReady())return null;var t,n,r=new Uint8Array(this.mp4track.len),i=0,o=this.mp4track.samples;for(this.dts=this.nextDts;this.samples.length;){var a=this.samples.shift();if(a.units,(n=a.duration)<=0){h("remuxer: invalid sample duration at DTS: ".concat(this.nextDts," :").concat(n)),this.mp4track.len-=a.size;continue}this.nextDts+=n,t={size:a.size,duration:n,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},r.set(a.units,i),i+=a.size,o.push(t)}return o.length?new Uint8Array(r.buffer,0,this.mp4track.len):null}},{key:"getAacParser",value:function e(){return this.aac}}]),r}(F),E=function(e){a(r,e);var t=u(r);function r(e){var i;return n(this,r),(i=t.call(this)).readyToDecode=!1,i.nextDts=0,i.dts=0,i.mp4track={id:F.getTrackID(),type:"video",len:0,fragmented:!0,sps:"",pps:"",fps:30,width:0,height:0,timescale:e,duration:e,samples:[]},i.samples=[],i.h264=new b(c(i)),i}return i(r,[{key:"resetTrack",value:function e(){this.readyToDecode=!1,this.mp4track.sps="",this.mp4track.pps="",this.nextDts=0,this.dts=0}},{key:"remux",value:function e(t){var n,r=f(t);try{for(r.s();!(n=r.n()).done;){var i,o=n.value,a=[],s=0,$=f(o.units);try{for($.s();!(i=$.n()).done;){var c=i.value;this.h264.parseNAL(c)&&(a.push(c),s+=c.getSize())}}catch(u){$.e(u)}finally{$.f()}a.length>0&&this.readyToDecode&&(this.mp4track.len+=s,this.samples.push({units:a,size:s,keyFrame:o.keyFrame,duration:o.duration,compositionTimeOffset:o.compositionTimeOffset}))}}catch(l){r.e(l)}finally{r.f()}}},{key:"getPayload",value:function e(){if(!this.isReady())return null;var t=new Uint8Array(this.mp4track.len),n=0,r=this.mp4track.samples;for(this.dts=this.nextDts;this.samples.length;){var i=this.samples.shift(),o=i.units;if((s=i.duration)<=0){h("remuxer: invalid sample duration at DTS: ".concat(this.nextDts," :").concat(s)),this.mp4track.len-=i.size;continue}this.nextDts+=s,a={size:i.size,duration:s,cts:i.compositionTimeOffset||0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,isNonSync:i.keyFrame?0:1,dependsOn:i.keyFrame?2:1}};var a,s,$,c=f(o);try{for(c.s();!($=c.n()).done;){var u=$.value;t.set(u.getData(),n),n+=u.getSize()}}catch(l){c.e(l)}finally{c.f()}r.push(a)}return r.length?new Uint8Array(t.buffer,0,this.mp4track.len):null}}]),r}(F),D=function(e){a(r,e);var t=u(r);function r(e){var i;return n(this,r),(i=t.call(this,"remuxer")).initialized=!1,i.trackTypes=[],i.tracks={},i.seq=1,i.env=e,i.timescale=1e3,i.mediaDuration=0,i.aacParser=null,i}return i(r,[{key:"addTrack",value:function e(t){if(("video"===t||"both"===t)&&(this.tracks.video=new E(this.timescale),this.trackTypes.push("video")),"audio"===t||"both"===t){var n=new B(this.timescale);this.aacParser=n.getAacParser(),this.tracks.audio=n,this.trackTypes.push("audio")}}},{key:"reset",value:function e(){var t,n=f(this.trackTypes);try{for(n.s();!(t=n.n()).done;){var r=t.value;this.tracks[r].resetTrack()}}catch(i){n.e(i)}finally{n.f()}this.initialized=!1}},{key:"destroy",value:function e(){this.tracks={},this.offAll()}},{key:"flush",value:function e(){if(this.initialized){var t,n=f(this.trackTypes);try{for(n.s();!(t=n.n()).done;){var r=t.value,i=this.tracks[r],o=i.getPayload();if(o&&o.byteLength){var a=S.moof(this.seq,i.dts,i.mp4track),s=S.mdat(o),$=v(a,s),c={type:r,payload:$,dts:i.dts};"video"===r&&(c.fps=i.mp4track.fps),this.dispatch("buffer",c);var u=g(i.dts/this.timescale);h("put segment (".concat(r,"): dts: ").concat(i.dts," frames: ").concat(i.mp4track.samples.length," second: ").concat(u)),i.flush(),this.seq++}}}catch(l){n.e(l)}finally{n.f()}}else this.isReady()&&(this.dispatch("ready"),this.initSegment(),this.initialized=!0,this.flush())}},{key:"initSegment",value:function e(){var t,n=[],r=f(this.trackTypes);try{for(r.s();!(t=r.n()).done;){var i=t.value,o=this.tracks[i];if("browser"==this.env){var a={type:i,payload:S.initSegment([o.mp4track],this.mediaDuration,this.timescale)};this.dispatch("buffer",a)}else n.push(o.mp4track)}}catch(s){r.e(s)}finally{r.f()}if("node"==this.env){var $={type:"all",payload:S.initSegment(n,this.mediaDuration,this.timescale)};this.dispatch("buffer",$)}h("Initial segment generated.")}},{key:"isReady",value:function e(){var t,n=f(this.trackTypes);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(!this.tracks[r].readyToDecode||!this.tracks[r].samples.length)return!1}}catch(i){n.e(i)}finally{n.f()}return!0}},{key:"remux",value:function e(t){var n,r=f(this.trackTypes);try{for(r.s();!(n=r.n()).done;){var i=n.value,o=t[i];("audio"!==i||!this.tracks.video||this.tracks.video.readyToDecode)&&o.length>0&&this.tracks[i].remux(o)}}catch(a){r.e(a)}finally{r.f()}this.flush()}}]),r}(w),T=function(e){a(r,e);var t=u(r);function r(e,i){var o;return n(this,r),(o=t.call(this,"buffer")).type=i,o.queue=new Uint8Array,o.cleaning=!1,o.pendingCleaning=0,o.cleanOffset=30,o.cleanRanges=[],o.sourceBuffer=e,o.sourceBuffer.addEventListener("updateend",function(){if(o.pendingCleaning>0&&(o.initCleanup(o.pendingCleaning),o.pendingCleaning=0),o.cleaning=!1,o.cleanRanges.length){o.doCleanup();return}}),o.sourceBuffer.addEventListener("error",function(){o.dispatch("error",{type:o.type,name:"buffer",error:"buffer error"})}),o}return i(r,[{key:"destroy",value:function e(){this.queue=null,this.sourceBuffer=null,this.offAll()}},{key:"doCleanup",value:function e(){if(!this.cleanRanges.length){this.cleaning=!1;return}var t=this.cleanRanges.shift();h("".concat(this.type," remove range [").concat(t[0]," - ").concat(t[1],")")),this.cleaning=!0,this.sourceBuffer.remove(t[0],t[1])}},{key:"initCleanup",value:function e(t){try{if(this.sourceBuffer.updating){this.pendingCleaning=t;return}if(this.sourceBuffer.buffered&&this.sourceBuffer.buffered.length&&!this.cleaning){for(var n=0;n<this.sourceBuffer.buffered.length;++n){var r=this.sourceBuffer.buffered.start(n),i=this.sourceBuffer.buffered.end(n);t-r>this.cleanOffset&&(i=t-this.cleanOffset,r<i&&this.cleanRanges.push([r,i]))}this.doCleanup()}}catch(o){p("Error occured while cleaning ".concat(this.type," buffer - ").concat(o.name,": ").concat(o.message))}}},{key:"doAppend",value:function e(){if(this.queue.length&&this.sourceBuffer&&!this.sourceBuffer.updating)try{this.sourceBuffer.appendBuffer(this.queue),this.queue=new Uint8Array}catch(t){var n="unexpectedError";"QuotaExceededError"===t.name?(h("".concat(this.type," buffer quota full")),n="QuotaExceeded"):(p("Error occured while appending ".concat(this.type," buffer - ").concat(t.name,": ").concat(t.message)),n="InvalidStateError"),this.dispatch("error",{type:this.type,name:n,error:"buffer error"})}}},{key:"feed",value:function e(t){this.queue=v(this.queue,t)}}]),r}(w);return function(r){a(s,r);var o=u(s);function s(e){var r;return n(this,s),(r=o.call(this,"jmuxer")).isReset=!1,r.options=Object.assign({},{node:"",mode:"both",flushingTime:500,maxDelay:500,clearBuffer:!0,fps:30,readFpsFromTrack:!1,debug:!1,onReady:function e(){},onData:function e(){},onError:function e(){},onMissingVideoFrames:function e(){},onMissingAudioFrames:function e(){}},e),r.env=("undefined"==typeof process?"undefined":t(process))==="object"&&"undefined"==typeof window?"node":"browser",r.options.debug&&(x=console.log,y=console.error),r.options.fps||(r.options.fps=30),r.frameDuration=1e3/r.options.fps|0,r.remuxController=new D(r.env),r.remuxController.addTrack(r.options.mode),r.initData(),r.remuxController.on("buffer",r.onBuffer.bind(c(r))),"browser"==r.env&&(r.remuxController.on("ready",r.createBuffer.bind(c(r))),r.initBrowser()),r}return i(s,[{key:"initData",value:function e(){this.lastCleaningTime=Date.now(),this.kfPosition=[],this.kfCounter=0,this.pendingUnits={},this.remainingData=new Uint8Array,this.startInterval()}},{key:"initBrowser",value:function e(){"string"==typeof this.options.node&&""==this.options.node&&p("no video element were found to render, provide a valid video element"),this.node="string"==typeof this.options.node?document.getElementById(this.options.node):this.options.node,this.mseReady=!1,this.setupMSE()}},{key:"createStream",value:function t(){var n=this.feed.bind(this),r=this.destroy.bind(this);return this.stream=new e.Duplex({writableObjectMode:!0,read:function e(t){},write:function e(t,r,i){n(t),i()},final:function e(t){r(),t()}}),this.stream}},{key:"setupMSE",value:function e(){if(window.MediaSource=window.MediaSource||window.WebKitMediaSource||window.ManagedMediaSource,!window.MediaSource)throw"Oops! Browser does not support Media Source Extension or Managed Media Source (IOS 17+).";if(this.isMSESupported=!!window.MediaSource,this.mediaSource=new window.MediaSource,this.url=URL.createObjectURL(this.mediaSource),window.MediaSource===window.ManagedMediaSource)try{this.node.removeAttribute("src"),this.node.disableRemotePlayback=!0;var t=document.createElement("source");t.type="video/mp4",t.src=this.url,this.node.appendChild(t),this.node.load()}catch(n){this.node.src=this.url}else this.node.src=this.url;this.mseEnded=!1,this.mediaSource.addEventListener("sourceopen",this.onMSEOpen.bind(this)),this.mediaSource.addEventListener("sourceclose",this.onMSEClose.bind(this)),this.mediaSource.addEventListener("webkitsourceopen",this.onMSEOpen.bind(this)),this.mediaSource.addEventListener("webkitsourceclose",this.onMSEClose.bind(this))}},{key:"endMSE",value:function e(){if(!this.mseEnded)try{this.mseEnded=!0,this.mediaSource.endOfStream()}catch(t){p("mediasource is not available to end")}}},{key:"feed",value:function e(t){var n,r,i,o=!1,a={video:[],audio:[]};if(t&&this.remuxController){if(i=t.duration?parseInt(t.duration):0,t.video){t.video=v(this.remainingData,t.video);var s,$,c=function e(t){if(Array.isArray(t))return t}(s=b.extractNALu(t.video))||function e(t,n){var r,i,o=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=o){var a=[],s=!0,$=!1;try{for(o=o.call(t);!(s=(r=o.next()).done)&&(a.push(r.value),!n||a.length!==n);s=!0);}catch(c){$=!0,i=c}finally{try{s||null==o.return||o.return()}finally{if($)throw i}}return a}}(s,2)||l(s,2)||function e(){throw TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}();if(n=c[0],r=c[1],this.remainingData=r||new Uint8Array,n.length>0)a.video=this.getVideoFrames(n,i,t.compositionTimeOffset),o=!0;else{p("Failed to extract any NAL units from video data:",r),"function"==typeof this.options.onMissingVideoFrames&&this.options.onMissingVideoFrames.call(null,t);return}}if(t.audio){if((n=_.extractAAC(t.audio)).length>0)a.audio=this.getAudioFrames(n,i),o=!0;else{p("Failed to extract audio data from:",t.audio),"function"==typeof this.options.onMissingAudioFrames&&this.options.onMissingAudioFrames.call(null,t);return}}if(!o){p("Input object must have video and/or audio property. Make sure it is a valid typed array");return}this.remuxController.remux(a)}}},{key:"getVideoFrames",value:function e(t,n,r){var i=this,o=[],a=[],s=0,$=0,c=!1,u=!1;this.pendingUnits.units&&(o=this.pendingUnits.units,u=this.pendingUnits.vcl,c=this.pendingUnits.keyFrame,this.pendingUnits={});var l,d=f(t);try{for(d.s();!(l=d.n()).done;){var p=l.value,x=new m(p);(x.type()===m.IDR||x.type()===m.NDR)&&b.parseHeader(x),o.length&&u&&(x.isfmb||!x.isvcl)&&(a.push({units:o,keyFrame:c}),o=[],c=!1,u=!1),o.push(x),c=c||x.isKeyframe(),u=u||x.isvcl}}catch(y){d.e(y)}finally{d.f()}if(o.length){if(n){if(u)a.push({units:o,keyFrame:c});else{var v=a.length-1;v>=0&&(a[v].units=a[v].units.concat(o))}}else this.pendingUnits={units:o,keyFrame:c,vcl:u}}return s=n?n/a.length|0:this.frameDuration,$=n?n-s*a.length:0,a.map(function(e){e.duration=s,e.compositionTimeOffset=r,$>0&&(e.duration++,$--),i.kfCounter++,e.keyFrame&&i.options.clearBuffer&&i.kfPosition.push(i.kfCounter*s/1e3)}),h("jmuxer: No. of frames of the last chunk: ".concat(a.length)),a}},{key:"getAudioFrames",value:function e(t,n){var r,i=[],o=0,a=0,s=f(t);try{for(s.s();!(r=s.n()).done;){var $=r.value;i.push({units:$})}}catch(c){s.e(c)}finally{s.f()}return o=n?n/i.length|0:this.frameDuration,a=n?n-o*i.length:0,i.map(function(e){e.duration=o,a>0&&(e.duration++,a--)}),i}},{key:"destroy",value:function e(){if(this.stopInterval(),this.stream&&(this.remuxController.flush(),this.stream.push(null),this.stream=null),this.remuxController&&(this.remuxController.destroy(),this.remuxController=null),this.bufferControllers){for(var t in this.bufferControllers)this.bufferControllers[t].destroy();this.bufferControllers=null,this.endMSE()}this.node=!1,this.mseReady=!1,this.videoStarted=!1,this.mediaSource=null}},{key:"reset",value:function e(){if(this.stopInterval(),this.isReset=!0,this.node.pause(),this.remuxController&&this.remuxController.reset(),this.bufferControllers){for(var t in this.bufferControllers)this.bufferControllers[t].destroy();this.bufferControllers=null,this.endMSE()}this.initData(),"browser"==this.env&&this.initBrowser(),h("JMuxer was reset")}},{key:"createBuffer",value:function e(){if(this.mseReady&&this.remuxController&&this.remuxController.isReady()&&!this.bufferControllers)for(var t in this.bufferControllers={},this.remuxController.tracks){var n=this.remuxController.tracks[t];if(!s.isSupported("".concat(t,'/mp4; codecs="').concat(n.mp4track.codec,'"')))return p("Browser does not support codec"),!1;var r=this.mediaSource.addSourceBuffer("".concat(t,'/mp4; codecs="').concat(n.mp4track.codec,'"'));this.bufferControllers[t]=new T(r,t),this.bufferControllers[t].on("error",this.onBufferError.bind(this))}}},{key:"startInterval",value:function e(){var t=this;this.interval=setInterval(function(){t.options.flushingTime?t.applyAndClearBuffer():t.bufferControllers&&t.cancelDelay()},this.options.flushingTime||1e3)}},{key:"stopInterval",value:function e(){this.interval&&clearInterval(this.interval)}},{key:"cancelDelay",value:function e(){if(this.node.buffered&&this.node.buffered.length>0&&!this.node.seeking){var t=this.node.buffered.end(0);t-this.node.currentTime>this.options.maxDelay/1e3&&(console.log("delay"),this.node.currentTime=t-.001)}}},{key:"releaseBuffer",value:function e(){for(var t in this.bufferControllers)this.bufferControllers[t].doAppend()}},{key:"applyAndClearBuffer",value:function e(){this.bufferControllers&&(this.releaseBuffer(),this.clearBuffer())}},{key:"getSafeClearOffsetOfBuffer",value:function e(t){for(var n,r="audio"===this.options.mode&&t||0,i=0;i<this.kfPosition.length&&!(this.kfPosition[i]>=t);i++)n=this.kfPosition[i];return n&&(this.kfPosition=this.kfPosition.filter(function(e){return e<n&&(r=e),e>=n})),r}},{key:"clearBuffer",value:function e(){if(this.options.clearBuffer&&Date.now()-this.lastCleaningTime>1e4){for(var t in this.bufferControllers){var n=this.getSafeClearOffsetOfBuffer(this.node.currentTime);this.bufferControllers[t].initCleanup(n)}this.lastCleaningTime=Date.now()}}},{key:"onBuffer",value:function e(t){this.options.readFpsFromTrack&&void 0!==t.fps&&this.options.fps!=t.fps&&(this.options.fps=t.fps,this.frameDuration=Math.ceil(1e3/t.fps),h("JMuxer changed FPS to ".concat(t.fps," from track data"))),"browser"==this.env?this.bufferControllers&&this.bufferControllers[t.type]&&this.bufferControllers[t.type].feed(t.payload):this.stream&&this.stream.push(t.payload),this.options.onData&&this.options.onData(t.payload),0===this.options.flushingTime&&this.applyAndClearBuffer()}},{key:"onMSEOpen",value:function e(){this.mseReady=!0,URL.revokeObjectURL(this.url),"function"==typeof this.options.onReady&&this.options.onReady.call(null,this.isReset)}},{key:"onMSEClose",value:function e(){this.mseReady=!1,this.videoStarted=!1}},{key:"onBufferError",value:function e(t){if("QuotaExceeded"==t.name){h("JMuxer cleaning ".concat(t.type," buffer due to QuotaExceeded error")),this.bufferControllers[t.type].initCleanup(this.node.currentTime);return}"InvalidStateError"==t.name?(h("JMuxer is reseting due to InvalidStateError"),this.reset()):this.endMSE(),"function"==typeof this.options.onError&&this.options.onError.call(null,t)}}],[{key:"isSupported",value:function e(t){return window.MediaSource&&window.MediaSource.isTypeSupported(t)}}]),s}(w)});